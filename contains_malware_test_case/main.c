#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <errno.h>
#include "md5.c"
#include "cmpdb.c"
#include "structs.c"

#include <windows.h>
#define DEFAULTMD5SIZE 32

char *MD5_file (char *path, int md5_len){
    errno = 0;
	/* creating structure for using md5 */

	FILE *fp = fopen (path, "rb");
	if (fp == NULL){
		fprintf (stderr, "fopen %s failed\n", path);

        printf("Error %d \n", errno);
		return NULL;
	}

	/*
		The MD5Init(), MD5Update(), and MD5Final() functions are the core functions.
		Allocate an MD5_CTX, initialize it with MD5Init(), run over the data with MD5Update(),
		and finally extract the result using MD5Final().

		by using these :
		* MD5Context md5;
		* MD5Init(&md5);
		* MD5Update(&md5, data, datalen);
		* MD5Final(digest, &md5);
		splitting it up into that many functions is to let you stream large datasets.
		would read the file in smaller chunks
	*/
	MD5_CTX mdContext;
	MD5Init(&mdContext);

	/*
		by using fread here , every single byte from file
		will be read and put in to data array
		updating byte by byte to do the function in smaller chunks
	*/

	int bytes;
	unsigned char data[1024];
	while ((bytes = fread (data, 1, 1024, fp)) != 0){
		MD5Update(&mdContext, data, bytes);
	}

	/*
		path -> *fp -> data -> update data -> mdContext -> finilize
		finilizing md5 structure
	*/
	MD5Final (&mdContext);



	char *file_md5;
	file_md5 = (char *)malloc((md5_len + 1) * sizeof(char));
	if(file_md5 == NULL){
		printf("Allocation memory failed !\n");
		return NULL;
	}

	/* coping zero value to md_len + 1 character of file_md5 (initilization) */

	memset(file_md5, 0, (md5_len + 1));


	int i;
	if(md5_len == 16){
		for(i=4; i<12; i++){
			// writing digest of mdContext in file_md5 in hex mode
			sprintf(&file_md5[(i-4)*2], "%02x", mdContext.digest[i]);
		}
	}
	else if(md5_len == 32){
		for(i=0; i<16; i++){
			sprintf(&file_md5[i*2], "%02x", mdContext.digest[i]);
		}
	}

	else{
		fclose(fp);
		free(file_md5);
		return NULL;
	}

	fclose (fp);
	return file_md5;
}


int main(int argc, char *argv[]){



	/*
		1- get malwares folder
		2- convert file in malwares folder to their hash
		3- get database file
		4- compare each produced hashed to hashes in database file
		5- if ture returned , ask user to wanna delete them or not
		6- finish
	*/

	char username[MAX_COMPUTERNAME_LENGTH + 1]; 
  	DWORD size = MAX_COMPUTERNAME_LENGTH + 1 ;
  	GetComputerName( username, &size );
	
    printf("Hello user %s.\nPlease Enter a path to search :" , username);
    char *md5;
    char path[2000];
    gets(path);
    strcat(path,"\\");
    DIR *d;
    struct dirent *dir;
    int flag = 0;
    int i = 0 ;
    d = opendir(path);
    struct Node *head = NULL;
	int virus_counter = 0;
    if(d){

		// skip . and .. directory to reach files.
        while ((dir = readdir(d)) != NULL && flag != 1){
            flag++;
        }
        while((dir = readdir(d)) != NULL){
            printf("\nFile name : %s\n" , dir->d_name);
            char malwares_folder[2000] = {0};
            for(i=0 ; i<strlen(path) ; i++){
                malwares_folder[i] = path[i];
            }
            strcat(malwares_folder, dir->d_name);
            md5 = MD5_file(malwares_folder, DEFAULTMD5SIZE);
            printf("MD5 : %s\n" , md5);
            if(cmpdb(md5 , DEFAULTMD5SIZE) == 1){
                head = add(dir->d_name , head);
				virus_counter++;
				//record_in_table(username,sql);
                printf("*****THIS '%s' IS VIRUS!*****\n\n" , dir->d_name);
            }
    	}
    closedir(d);
    }
	char removeit[4];
	struct Node *temp = head;
	printf("%d malware founded : \n" , virus_counter);
	while(temp != NULL){
		printf("Would you like to delete this malware?\n [%s]" , temp->name);
		scanf("%s" , &removeit);
		if(strcmp(removeit,"yes") == 0)
			remove(temp->name);
		temp = temp -> next;
	}
}
